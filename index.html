<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тапалка Игра</title>
    <!-- Tailwind CSS import -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #1a202c; /* Dark background */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #e2e8f0; /* Light text */
        }
        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #2d3748; /* Gray container background */
            padding: 40px;
            border-radius: 15px; /* Rounded corners */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); /* Shadow */
            text-align: center;
            width: 100%;
            max-width: 450px; /* Max width for responsiveness */
        }
        .click-button {
            background-color: #3b82f6; /* Blue button */
            color: white;
            padding: 15px 30px;
            font-size: 1.5rem;
            border: none;
            border-radius: 10px; /* Rounded button corners */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            margin-top: 20px;
            width: 100%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .click-button:hover:not(:disabled) {
            background-color: #2563eb; /* Darker on hover */
            transform: translateY(-2px); /* Slight lift */
        }
        .click-button:active:not(:disabled) {
            transform: translateY(0); /* Press effect */
        }
        .click-button:disabled {
            background-color: #4a5568; /* Gray for disabled button */
            cursor: not-allowed;
            box-shadow: none;
        }
        .score-text {
            font-size: 3rem;
            font-weight: bold;
            color: #68d391; /* Green for score */
            margin-top: 15px;
        }
        .instruction-text {
            font-size: 1.2rem;
            color: #cbd5e0; /* Light gray for instructions */
            margin-bottom: 20px;
        }
        .timer-text {
            font-size: 1.5rem;
            color: #f6ad55; /* Orange for timer */
            margin-top: 10px;
        }
        .loading-text {
            font-size: 1.2rem;
            color: #a0aec0;
            margin-top: 10px;
        }
    </style>
    <!-- Monetag Ad Block Code (Interstitial) -->
    <script src='//libtl.com/sdk.js' data-zone='9473169' data-sdk='show_9473169'></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Initialize Firebase app if not already initialized
                if (!window.firebaseApp) {
                    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                    window.firebaseApp = initializeApp(firebaseConfig);
                    window.db = getFirestore(window.firebaseApp);
                    window.auth = getAuth(window.firebaseApp);
                }

                // Authenticate user
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Authenticated with UID:", window.userId);
                    } else {
                        console.log("No user signed in. Attempting anonymous sign-in.");
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(window.auth, __initial_auth_token);
                                window.userId = window.auth.currentUser.uid;
                                console.log("Signed in with custom token:", window.userId);
                            } else {
                                await signInAnonymously(window.auth);
                                window.userId = window.auth.currentUser.uid;
                                console.log("Signed in anonymously:", window.userId);
                            }
                        } catch (error) {
                            console.error("Firebase authentication error:", error);
                            // Fallback if authentication fails, use a random ID or provide a user-friendly message
                            window.userId = crypto.randomUUID();
                            console.warn("Authentication failed, using random UUID for userId:", window.userId);
                        }
                    }
                    window.isAuthReady = true;
                    // Trigger initial score load after auth is ready
                    if (typeof window.loadTapCoins === 'function') {
                        await window.loadTapCoins();
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loadingText').textContent = "Ошибка загрузки игры. Пожалуйста, попробуйте еще раз.";
                document.getElementById('clickButton').disabled = true;
            }
        });

        // Save score when the app is closed or hidden (as a fallback)
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'hidden' && typeof window.saveTapCoins === 'function') {
                console.log("Document hidden, attempting to save score.");
                await window.saveTapCoins();
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-green-400">Тапалка Игра</h1>
        <p class="instruction-text">Нажимайте на кнопку, чтобы получить TapCoins!</p>
        <p class="score-text">TapCoins: <span id="score">0</span></p>
        <button id="clickButton" class="click-button" disabled>Загрузка...</button>
        <p id="timerDisplay" class="timer-text hidden"></p> <!-- Element to display the timer -->
        <p id="loadingText" class="loading-text">Загрузка данных...</p>
    </div>

    <script type="module">
        import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const scoreDisplay = document.getElementById('score');
        const clickButton = document.getElementById('clickButton');
        const timerDisplay = document.getElementById('timerDisplay');
        const loadingText = document.getElementById('loadingText');

        let score = 0;
        const adTimerDuration = 15; // Timer duration in seconds (15 or 30)

        // Function to load TapCoins from Firestore
        window.loadTapCoins = async () => {
            if (!window.isAuthReady || !window.db || !window.userId) {
                console.log("Firebase not ready for loading, retrying...");
                setTimeout(window.loadTapCoins, 500); // Retry after 500ms
                return;
            }

            loadingText.textContent = "Загрузка TapCoins...";
            clickButton.disabled = true; // Disable button while loading

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userDocRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/user_data/score`);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    score = docSnap.data().tapCoins || 0;
                    console.log("TapCoins loaded:", score);
                } else {
                    score = 0;
                    console.log("No existing TapCoins, starting from 0.");
                    // Optionally, save initial 0 score
                    await setDoc(userDocRef, { tapCoins: 0 });
                }
                scoreDisplay.textContent = score;
                loadingText.textContent = ""; // Clear loading message
                clickButton.disabled = false; // Enable button
                clickButton.textContent = 'Получить TapCoins';
            } catch (error) {
                console.error("Error loading TapCoins:", error);
                loadingText.textContent = "Ошибка загрузки TapCoins. Пожалуйста, перезапустите игру.";
                clickButton.disabled = true;
            }
        };

        // Function to save TapCoins to Firestore
        window.saveTapCoins = async () => {
            if (!window.isAuthReady || !window.db || !window.userId) {
                console.warn("Firebase not ready for saving. Skipping save.");
                return;
            }

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userDocRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/user_data/score`);
                await setDoc(userDocRef, { tapCoins: score });
                console.log("TapCoins saved:", score);
            } catch (error) {
                console.error("Error saving TapCoins:", error);
            }
        };

        // Function to call the Monetag ad block
        function showMonetagAd() {
            if (typeof show_9473169 === 'function') {
                console.log("Calling Monetag ad...");
                show_9473169();
            } else {
                console.warn("Function show_9473169() not found. Monetag SDK might not have loaded yet or the zone is configured differently.");
                // Fallback: if ad doesn't show, continue as normal
            }
        }

        // Click event handler for the button
        clickButton.addEventListener('click', async () => {
            clickButton.disabled = true;
            clickButton.textContent = 'Загрузка рекламы...';
            timerDisplay.classList.add('hidden');

            showMonetagAd();

            let timeLeft = adTimerDuration;
            timerDisplay.textContent = `До награды: ${timeLeft} сек`;
            timerDisplay.classList.remove('hidden');

            const timerInterval = setInterval(async () => { // Made async to allow await
                timeLeft--;
                timerDisplay.textContent = `До награды: ${timeLeft} сек`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    score++;
                    scoreDisplay.textContent = score;
                    clickButton.textContent = 'Получить TapCoins';
                    clickButton.disabled = false;
                    timerDisplay.classList.add('hidden');
                    console.log('Score increased, button active. Saving...');
                    await window.saveTapCoins(); // Save score immediately after getting a TapCoin
                }
            }, 1000);
        });

        // Initial load of TapCoins when the page is ready and Firebase is initialized
        // This is handled by onAuthStateChanged in the first script tag
    </script>
</body>
</html>
